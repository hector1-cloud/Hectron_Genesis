name: "HECTRON-Ψ ORBITAL SYNC"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. AUDITORÍA DE SEGURIDAD (Ejecutado por Security Guardian)
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: "Security Guardian: Scanning for Entropy"
        uses: snyk/actions/python@master # Basado en
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: "Vault: Secret Management Check"
        run: |
          echo "Verificando que no haya llaves de xAI o CCXT expuestas..."
          # Implementación de escaneo de secretos para proteger xAI_KEY y API_SECRET

  # 2. VALIDACIÓN DEL NÚCLEO COGNITIVO
  core-validation:
    needs: security-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: "Testing HectronAutonomo Logic" # Basado en
        run: |
          pip install -r requirements.txt
          pytest core/cognitive/tests/
      - name: "Reflective Check: Lewis & Sarkadi Protocol"
        run: python core/cognitive/validate_reflexion.py # Basado en

  # 3. DESPLIEGUE MULTI-PLATAFORMA (PRODUCCIÓN)
  deploy-sovereignty:
    needs: core-validation
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      # A. WEB PORTAL (Next.js 15 + React 19)
      - name: "Deploy to Vercel: Portal Alpha" # Basado en
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./apps/web-portal

      # B. BACKEND & MAMMON ENGINE (FastAPI + CCXT)
      - name: "Deploy to Railway: Mammon & Agents" # Basado en
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          railway up --service hectron-core
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}

      # C. MOBILE APP (Expo/EAS)
      - name: "Build Mobile: Hectron Pocket" # Basado en
        uses: expo/expo-github-action@v8
        with:
          eas-cache: true
          token: ${{ secrets.EXPO_TOKEN }}
